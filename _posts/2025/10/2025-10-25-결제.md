---
title: "결제"
categories: [ "Backend" ]
tags: [ "[인프런] 제미니 개발실무 - 커머스 백엔드 기본편" ]
date: "2025-10-25 03:22:00"
---

## 결제 흐름

![](/assets/img/posts/2025/10/2025-10-25-결제/204525922878000.png)

- 결제를 생성
- 결제 성공 및 실패 시, 결제 엔티티 값 수정
- 결제 성공 및 실패 시, 히스토리 내역 남기기

## API

### 결제 생성

```bash
POST /v1/payments
```

| Parameter        | 설명      |
|------------------|---------|
| orderKey         | 주문 키    |
| useOwnedCouponId | 사용한 쿠폰  |
| usePoint         | 사용한 포인트 |

1. `주문 키`에 해당하는 `주문` 조회
2. 해당 `상품`에 사용 가능한 `쿠폰` 조회
3. `포인트` 잔액 조회
4. `쿠폰` 및 `포인트` 차감 후 `결제 금액` 계산
5. `주문`이 `READY` 상태인지 체크
6. `결제 상태` `READY`로 `결제 엔티티` 생성 및 저장

### 결제 성공

```bash
POST /v1/payments/callback/success
```

| Parameter  |                |
|------------|----------------|
| orderId    | 주문 키(PG사 측 스펙) |
| paymentKey | 결제 키(PG사 측 스펙) |
| amount     | 금액             |

1. `주문 키` 및 `주문 상태`가 `CREATED`인 `주문` 조회
2. `주문`에 해당하는 `결제` 조회
3. `결제 유저`와 `주문 유저`가 동일한지 체크
4. `결제 상태`가 `READY`인지 체크
5. `결제 금액`과 파라미터로 받은 `금액`이 일치하는지 체크
6. 결제 외부 API 호출
7. `결제 엔티티` 살태 값 변경
8. `주문 엔티티` `PAID`로 상태 변경
9. 사용한 `쿠폰`이 있다면 `쿠폰 사용 완료`로 상태 값 변경
10. `포인트` 차감
11. `포인트` 적립
12. `결제 히스토리 테이블`에 성공 내역 저장

### 결제 실패

```bash
POST /v1/payments/callback/fail
```

| Parameter | 설명              |
|-----------|-----------------|
| orderId   | 주문 키(PG사 측 스펙)  |
| code      | 실패 코드(PG사 측 스펙) |
| message   | 메세지             |

1. `주문 키` 및 `주문 상태`가 `CREATED`인 `주문` 조회
2. `주문`에 해당하는 `결제` 조회
3. `결제 히스토리 테이블`에 실패 내역 저장

## 개념도

![](/assets/img/posts/2025/10/2025-10-25-결제/204919661701750.png)

- 결제는 주문을 의존
- 결제는 결제 시, 포인트와 쿠폰을 사용하므로 포인트와 쿠폰도 의존
- `TransactionHistory`에 결제 성공 및 실패에 대한 내역 저장

## 참고

- [https://www.inflearn.com/course/제미니의-개발실무-커머스-백엔드-기본](https://www.inflearn.com/course/%EC%A0%9C%EB%AF%B8%EB%8B%88%EC%9D%98-%EA%B0%9C%EB%B0%9C%EC%8B%A4%EB%AC%B4-%EC%BB%A4%EB%A8%B8%EC%8A%A4-%EB%B0%B1%EC%97%94%EB%93%9C-%EA%B8%B0%EB%B3%B8)
