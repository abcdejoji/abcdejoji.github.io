---
title: "정산"
categories: [ "Backend" ]
tags: [ "[인프런] 제미니 개발실무 - 커머스 백엔드 기본편" ]
date: "2025-10-27 14:31:00"
---

## 요구사항

![](/assets/img/_posts/2025/10/2025-10-27-정산/218748465428416.png)

## 요구사항 더 캐묻기

- 언제를 기준으로 정산을 해야 하는지?
- 돈은 언제 보내주는가?
- 정산 한 뒤, 취소 건이 발생하면 어떻게 처리할 것인지?
  - 다음 정산 때, 해당 금액을 제외하고 보내는 방법이 있음

## API

### 정산 대상 적재 배치

- 오전 1시 실행

```bash
POST /internal-batch/load-targets
```

1. 시작 시간, 종료 시간을 기준으로 결제 엔티티(완료)를 조회 (페이징 처리)
2. `주문id`에 해당하는 `결제id` 매핑하여 `Map`으로 만들기
3. `주문id`에 해당하는 `주문 항목` 조회
4. `주문 항목`에 있는 `상품id`로 `상품 판매처 매핑 엔티티` 조회
5. 위 데이터 기반으로 `정산 대상` 저장
6. 위와 동일한 방식으로 `결제 취소` 건에 대한 처리 (금액은 음수로 저장)

### 정산 계산 배치

- 오전 4시에 실행

```bash
POST /internal-batch/calculate
```

1. 정산 일자 기준으로 `정산 대상 테이블`에서 `판매처` 및 `정산 일자` 그룹핑으로 `금액 합계` 조회
2. 수수료 등 계산
3. `정산 준비` 상태로 `정산 엔티티` 생성하여 저장

### 정산 입금 배치

- 오전 9시에 실행

```bash
POST /internal-batch/transfer
```

1. `정산 테이블`에서 `정산 준비 상태`인 `정산 데이터` 조회
2. `판매처` 기준으로 매핑하여 `Map`으로 만들기
3. `판매처` 별 정산 금액 합산 (음수면 정산 X)
4. 정산 외부 API 호출
5. `정산 완료 상태`로 변경

> 시간에 텀을 줌으로서 오류 발생 시 처리할 시간을 벌 수 있습니다.

## 개념도

![](/assets/img/_posts/2025/10/2025-10-27-정산/222608398432875.png)

- `정산 대상`은 `결제`와 `취소`를 기반으로 생성되므로 의존
- `정산 대상`은 `주문 항목`을 통해 `상품id`를 가져오므로 `주문 항목`에 의존
- `정산`은 `정산 대상`에만 의존

> 중간에 `정산 대상` 도메인을 만듦으로써 `정산` 로직의 변경은 최소화 할 수 있습니다.

## 참고

- [https://www.inflearn.com/course/제미니의-개발실무-커머스-백엔드-기본](https://www.inflearn.com/course/%EC%A0%9C%EB%AF%B8%EB%8B%88%EC%9D%98-%EA%B0%9C%EB%B0%9C%EC%8B%A4%EB%AC%B4-%EC%BB%A4%EB%A8%B8%EC%8A%A4-%EB%B0%B1%EC%97%94%EB%93%9C-%EA%B8%B0%EB%B3%B8)
